/**
 * Plugin: TimeKeeper
 * Author: Sundarasan Natarajan
 * GIT: https://github.com/Sujsun/timekeeper.git
 * Version: 0.0.1
 */
!function(a,b){"object"==typeof exports?module.exports=b():"function"==typeof define&&define.amd?define([],b):a.TimeKeeper=b()}(window,function(){function a(a){return this._options=d.clone(a||{}),this._options=d.defaults(this._options,e),this._differenceInMillis=0,this}function b(b){return new a(b)}var c={call:function(a){var b,c,d;"object"==typeof a||(a={}),"string"==typeof a.type||(a.type="get"),"string"==typeof a.type&&(a.type=a.type.toUpperCase()),"function"==typeof a.success||(a.success=EMPTY_FUNCTION),"function"==typeof a.error||(a.error=EMPTY_FUNCTION);var e=new XMLHttpRequest;for(c in a.headers)d=a.headers[c],e.setRequestHeader(c,d);return e.onreadystatechange=function(){if(4==e.readyState)if(e.status>=200&&e.status<300||304==e.status){if(b=e.responseText,"json"===a.dataType)try{b=JSON.parse(e.responseText)}catch(c){a.error.call(a.context,c,e,a)}a.success.call(a.context,b,e,a)}else a.error.call(a.context,new Error("Ajax failed"),e,a)},e.open(a.type,a.url,!0),e.send(a.data),e}},d={clone:function(a){var b,c={};for(b in a)c[b]=a[b];return c},defaults:function(a,b){var c;for(c in b)"undefined"==typeof a[c]&&(a[c]=b[c]);return a},unbind:Function.bind.bind(Function.bind),instantiate:function(a,b){return new(this.unbind(a,null).apply(null,b))}},e={ajaxType:"get",ajaxMilliUrl:"/utcMillis",responseParser:function(a){return parseInt(a)}};return a.prototype.sync=function(){return this._sync.apply(this,arguments)},a.prototype.Date=function(){return this._getCorrectDate()},a.prototype.overrideDate=function(){var a=this;window.Date=function(b){function c(){var c=d.instantiate(b,arguments),e=arguments.length;return 0===e&&c.setTime(a._getCorrectDateMillis()),c}return c.prototype=b.prototype,c}(this._Date)},a.prototype.resetDate=function(){return window.Date=this._Date},a.prototype.setDifferenceInMillis=function(a){return this._differenceInMillis=a},a.prototype.getDifferenceInMillis=function(){return this._differenceInMillis},a.prototype._Date=window.Date,a.prototype._sync=function(a){a||(a=function(){});var b=this;this._getServerDateMillis(function(c,d){c?(console.error("Failed to fetch server time. Error:",c),a(c)):(b._findDifferenceInMillis(d),a(null,b.Date()))})},a.prototype._getCorrectDate=function(){return new this._Date(this._getCorrectDateMillis())},a.prototype._getCorrectDateMillis=function(){return this._getMachineDateMillis()+this._differenceInMillis},a.prototype._getMachineDateMillis=function(){return(new this._Date).getTime()},a.prototype._getServerDateMillis=function(a){var b=this;c.call({type:this._options.ajaxType,url:this._options.ajaxMilliUrl,success:function(c){a(null,b._options.responseParser(c))},error:function(b){a(b)}})},a.prototype._findDifferenceInMillis=function(a){this._differenceInMillis=this._getMachineDateMillis()-a},b});