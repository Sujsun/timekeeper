/**
 * Plugin: TimeKeeper
 * Author: Sundarasan Natarajan
 * GIT: https://github.com/Sujsun/timekeeper.git
 * Version: 0.0.1
 */
!function(a,b){"object"==typeof exports?module.exports=b():"function"==typeof define&&define.amd?define([],b):a.TimeKeeper=b()}(window,function(){function a(a){var b={},c=[];a=a||this,a.on=function(a,c,d){(b[a]=b[a]||[]).push([c,d])},a.off=function(a,d){a||(b={});for(var e=b[a]||c,f=e.length=d?e.length:0;f--;)d==e[f][0]&&e.splice(f,1)},a.emit=function(a){for(var d,e=b[a]||c,f=e.length>0?e.slice(0,e.length):e,g=0;d=f[g++];)d[0].apply(d[1],c.slice.call(arguments,1))}}function b(b){return this._options=e.clone(b||{}),this._options=e.defaults(this._options,f),this._differenceInMillis=this._options.differenceInMillis,this._isSyncedOnce=!1,this._event=new a,this.setCorrectTimeInMillis(this._options.correctTimeInMillis),this._options.overrideDate&&this.overrideDate(),this}function c(a){return new b(a)}var d={call:function(a){var b,c,d;"object"==typeof a||(a={}),"string"==typeof a.type||(a.type="get"),"string"==typeof a.type&&(a.type=a.type.toUpperCase()),"function"==typeof a.success||(a.success=EMPTY_FUNCTION),"function"==typeof a.error||(a.error=EMPTY_FUNCTION);var e=new XMLHttpRequest;for(c in a.headers)d=a.headers[c],e.setRequestHeader(c,d);return e.onreadystatechange=function(){if(4==e.readyState)if(e.status>=200&&e.status<300||304==e.status){if(b=e.responseText,"json"===a.dataType)try{b=JSON.parse(e.responseText)}catch(c){a.error.call(a.context,c,e,a)}a.success.call(a.context,b,e,a)}else a.error.call(a.context,new Error("Ajax failed"),e,a)},e.open(a.type,a.url,!0),e.send(a.data),e}},e={clone:function(a){var b,c={};for(b in a)c[b]=a[b];return c},defaults:function(a,b){var c;for(c in b)"undefined"==typeof a[c]&&(a[c]=b[c]);return a},unbind:Function.bind.bind(Function.bind),instantiate:function(a,b){return new(this.unbind(a,null).apply(null,b))}},f={ajaxType:"get",ajaxMilliUrl:"/utcMillis",syncInterval:6e4,differenceInMillis:0,overrideDate:!1,responseParser:function(a){return parseInt(a)}},g={SYNC:"sync",SYNCED:"synced",SYNC_ERROR:"sync_error",FIRST_SYNC:"first_sync",FIRST_SYNCED:"first_synced",FIRST_SYNC_ERROR:"first_sync_error"};return b.prototype.sync=function(){return this._sync.apply(this,arguments)},b.prototype.Date=function(){return this._getCorrectDate()},b.prototype.overrideDate=function(){var a=this;window.Date=function(b){function c(){var c=e.instantiate(b,arguments),d=arguments.length;return 0===d&&c.setTime(a._getCorrectDateMillis()),c}return c.prototype=b.prototype,c}(this._Date)},b.prototype.releaseDate=function(){return window.Date=this._Date},b.prototype.setCorrectTimeInMillis=function(a){return"number"==typeof a&&this._findDifferenceInMillis(a)},b.prototype.setDifferenceInMillis=function(a){return this._differenceInMillis=a},b.prototype.getDifferenceInMillis=function(){return this._differenceInMillis},b.prototype.startSync=function(a){return this._startSync.apply(this,arguments)},b.prototype.stopSync=function(){return this._stopSync.apply(this,arguments)},b.prototype.on=function(){this._event.on.apply(this._event,arguments)},b.prototype.off=function(){this._event.off.apply(this._event,arguments)},b.prototype._Date=window.Date,b.prototype._startSync=function(a){var b=this;return"number"==typeof a&&(this._options.syncInterval=a),this.stopSync(),this.sync(),this._syncIntervalIndex=window.setInterval(function(){b.sync()},this._options.syncInterval)},b.prototype._stopSync=function(){window.clearInterval(this._syncIntervalIndex),delete this._syncIntervalIndex},b.prototype._sync=function(a){a||(a=function(){});var b=this,c=b.Date();this._emitPreSyncEvent(),this._getServerDateMillis(function(d,e){d?(console.error("Failed to fetch server time. Error:",d),a(d),b._emitSyncEvent(d)):(b._findDifferenceInMillis(e),c=b.Date(),a(null,c),b._emitSyncedEvent(null,c))})},b.prototype._emitPreFirstSyncEvent=function(){this._isSyncedOnce===!1&&this._event.emit(g.FIRST_SYNC)},b.prototype._emitPreSyncEvent=function(){this._emitPreFirstSyncEvent(),this._event.emit(g.SYNC)},b.prototype._emitFirstSyncedEvent=function(a,b){this._isSyncedOnce===!1&&(this._isSyncedOnce=!0,this._event.emit(a?g.FIRST_SYNC_ERROR:g.FIRST_SYNCED,a||b))},b.prototype._emitSyncedEvent=function(a,b){this._emitFirstSyncedEvent(a,b),this._event.emit(a?g.SYNC_ERROR:g.SYNCED,a||b)},b.prototype._getCorrectDate=function(){return new this._Date(this._getCorrectDateMillis())},b.prototype._getCorrectDateMillis=function(){return this._getMachineDateMillis()+this._differenceInMillis},b.prototype._getMachineDateMillis=function(){return(new this._Date).getTime()},b.prototype._getServerDateMillis=function(a){var b=this,c=(new this._Date).getTime();d.call({type:this._options.ajaxType,url:this._options.ajaxMilliUrl,success:function(d){var e=(new b._Date).getTime()-c,f=b._options.responseParser(d)-e/2;a(null,f)},error:function(b){a(b)}})},b.prototype._findDifferenceInMillis=function(a){this._differenceInMillis=this._getMachineDateMillis()-a},c});